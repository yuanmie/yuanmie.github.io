<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>从零开始实现一个简单的JSON库（Java） PART 2 | Hexo</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">从零开始实现一个简单的JSON库（Java） PART 2</h1><a id="logo" href="/.">Hexo</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/history/"><i class="fa fa-history"> 历史</i></a><a href="/comment/"><i class="fa fa-comment"> 留言</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">从零开始实现一个简单的JSON库（Java） PART 2</h1><div class="post-meta">Jun 4, 2017<span> | </span><span class="category"><a href="/categories/Java/">Java</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a data-disqus-identifier="2017/06/04/KsonPart2/" href="/2017/06/04/KsonPart2/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>上篇文章讲述了怎么把一个简单的Java POLO类转为JSON字符串， 这次让我们尝试将JSON字符串转化为Java中的map/class。<br>本篇文章将会涉及一些解析器的知识：token， 递归下降。不过这些不难理解，待会看了代码有可能自然就懂了。Kson使用了大量的递归，<br>递归确实是计算机科学中一个非常重要的概念（东西？）。<br><a id="more"></a><br>先上<a href="http://www.json.org/" target="_blank" rel="external">JSON规范</a>，我们参照这个来进行开发, 必看。</p>
<h2 id="Token"><a href="#Token" class="headerlink" title="Token"></a>Token</h2><p>我们先看Token的实现。Token是解析器中的一个最小单位，解析器(parser)根据Token来进行解析.Token就是将连续相关的字符聚在一起的小单位，比如1134，“abc”这些都是一个个Token。我们将这些字符流转换的Token，也是便于之后的解析。</p>
<p>我们先看一下Token类的定义。type是token的type，用枚举来表示可能更好点，我顺手就直接用了String.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Token</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String text; </div><div class="line">    <span class="keyword">private</span> String type;</div><div class="line">    <span class="keyword">private</span> String numberType;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> currIndex = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> text_length;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">char</span>[] charArray;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(String text)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.text = text;</div><div class="line">        <span class="keyword">this</span>.currIndex = <span class="number">0</span>;</div><div class="line">        <span class="keyword">this</span>.text_length = text.length();</div><div class="line">        <span class="keyword">this</span>.charArray = text.toCharArray();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>核心代码是nextToken函数，我们将一步步分析它。如果到了末尾，则简单返回空字符串。否则取当前字符，来进行判断。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">nextToken</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (eof()) <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line"></div><div class="line">        <span class="keyword">char</span> ch = charArray[currIndex];</div><div class="line">        String sign = <span class="string">""</span>;</div><div class="line">        <span class="keyword">int</span> oldIndex = <span class="number">0</span>;</div><div class="line">        <span class="keyword">switch</span> (ch) &#123;</div></pre></td></tr></table></figure></p>
<p>我们来看看true，false， null的token处理.如果当前字符是’t’，则检查是不是“true”，如果是则设置type为“true”， 返回“true”，否则报错。false和null同理。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">    handle true</div><div class="line"> */</div><div class="line"><span class="keyword">case</span> <span class="string">'t'</span>:</div><div class="line">    <span class="keyword">if</span> (charArray[currIndex + <span class="number">1</span>] == <span class="string">'r'</span> &amp;&amp; charArray[currIndex + <span class="number">2</span>] == <span class="string">'u'</span> </div><div class="line">    &amp;&amp; charArray[currIndex + <span class="number">3</span>] == <span class="string">'e'</span>) &#123;</div><div class="line">        currIndex += <span class="number">4</span>;</div><div class="line">        <span class="keyword">this</span>.type = <span class="string">"true"</span>;</div><div class="line">        <span class="keyword">return</span> <span class="string">"true"</span>;</div><div class="line">    &#125;</div><div class="line">    errorToken();</div><div class="line">    <span class="keyword">break</span>;</div><div class="line"><span class="comment">/*</span></div><div class="line">    handle false</div><div class="line"> */</div></pre></td></tr></table></figure></p>
<p>遇到’{‘,证明这是object的开始，’[‘证明这是array的开始，设置其对应的type，然后返回字符串表示。”},:]”，这些更规范的做法是给每一个字符一个type。这里没用是因为懒惰&gt;_&gt;。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">    handle object</div><div class="line"> */</div><div class="line"><span class="keyword">case</span> <span class="string">'&#123;'</span>:</div><div class="line">    <span class="keyword">this</span>.type = <span class="string">"object"</span>;</div><div class="line">    ++currIndex;</div><div class="line">    <span class="keyword">return</span> ch + <span class="string">""</span>;</div><div class="line"><span class="keyword">case</span> <span class="string">'['</span>:</div><div class="line">    <span class="keyword">this</span>.type = <span class="string">"array"</span>;</div><div class="line">    ++currIndex;</div><div class="line">    <span class="keyword">return</span> ch + <span class="string">""</span>;</div><div class="line"><span class="comment">/*</span></div><div class="line">It's no need to assign type for these token.</div><div class="line"> */</div><div class="line"><span class="keyword">case</span> <span class="string">'&#125;'</span>:</div><div class="line"><span class="keyword">case</span> <span class="string">','</span>:</div><div class="line"><span class="keyword">case</span> <span class="string">':'</span>:</div><div class="line"><span class="keyword">case</span> <span class="string">']'</span>:</div><div class="line">    ++currIndex;</div><div class="line">    <span class="keyword">return</span> ch + <span class="string">""</span>;</div><div class="line"><span class="comment">/*</span></div><div class="line">    handle string</div><div class="line"> */</div></pre></td></tr></table></figure></p>
<p>处理String的代码就有点长了。当前字符是’\”‘，我们知道逮到string了。我们一直捕获字符直到遇到’“‘，在这途中我们需要处理转义字符和处理unicode。<br>具体分析一下处理unicode的代码。当我们遇到\u,我们检查后面4个字符是不是正确的16进制数。如果校验正确，计算出codePoint，并检测是否是high surrogate,如果是则继续取low surrogate，并计算出最终的codePoint，最后转为字符。如果不是high surrogate,检测是不是Bmp范围内，将codePoint转为字符。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">'"'</span>:</div><div class="line">       StringBuffer buf = <span class="keyword">new</span> StringBuffer();</div><div class="line">       buf.append(<span class="string">"\""</span>);</div><div class="line">       <span class="keyword">int</span> c;</div><div class="line">       <span class="keyword">while</span> (!eof() &amp;&amp; ((c = charArray[++currIndex]) != <span class="string">'\"'</span>)) &#123;</div><div class="line">           <span class="keyword">switch</span>(c)&#123;</div><div class="line">               <span class="keyword">case</span> <span class="string">'\\'</span>:</div><div class="line">                   c = charArray[++currIndex];</div><div class="line">                   <span class="keyword">switch</span>(c)&#123;</div><div class="line">                       <span class="keyword">case</span> <span class="string">'\"'</span>: buf.append(<span class="string">'\"'</span>); <span class="keyword">break</span>;</div><div class="line">                       <span class="keyword">case</span> <span class="string">'\\'</span>: buf.append(<span class="string">'\\'</span>); <span class="keyword">break</span>;</div><div class="line">                       <span class="keyword">case</span> <span class="string">'/'</span>:  buf.append(<span class="string">'/'</span> ); <span class="keyword">break</span>;</div><div class="line">                       <span class="keyword">case</span> <span class="string">'b'</span>:  buf.append(<span class="string">'\b'</span>); <span class="keyword">break</span>;</div><div class="line">                       <span class="keyword">case</span> <span class="string">'f'</span>:  buf.append(<span class="string">'\f'</span>); <span class="keyword">break</span>;</div><div class="line">                       <span class="keyword">case</span> <span class="string">'n'</span>:  buf.append(<span class="string">'\n'</span>); <span class="keyword">break</span>;</div><div class="line">                       <span class="keyword">case</span> <span class="string">'r'</span>:  buf.append(<span class="string">'\r'</span>); <span class="keyword">break</span>;</div><div class="line">                       <span class="keyword">case</span> <span class="string">'t'</span>:  buf.append(<span class="string">'\t'</span>); <span class="keyword">break</span>;</div><div class="line">                       <span class="keyword">case</span> <span class="string">'u'</span>:</div><div class="line">                           <span class="comment">/*</span></div><div class="line">                               handle unicode character</div><div class="line">                            */</div><div class="line">                           ++currIndex;</div><div class="line">                           String code = text.substring(currIndex, currIndex + <span class="number">4</span>);</div><div class="line">                           <span class="keyword">if</span>(invalidCode(code))&#123;</div><div class="line">                               errorMessage(<span class="string">"invalid unicode!!!"</span>);</div><div class="line">                           &#125;</div><div class="line"></div><div class="line">                           <span class="keyword">int</span> codePoint = computeCodePoint(code);</div><div class="line">                           <span class="keyword">if</span>(Character.isHighSurrogate((<span class="keyword">char</span>)codePoint))&#123;</div><div class="line">                               currIndex += <span class="number">4</span>;</div><div class="line">                               <span class="keyword">int</span> highCodePoint = codePoint;</div><div class="line">                               <span class="keyword">if</span>(charArray[currIndex] == <span class="string">'\\'</span> &amp;&amp; charArray[currIndex + <span class="number">1</span>] == <span class="string">'u'</span>)&#123;</div><div class="line">                                   currIndex += <span class="number">2</span>;</div><div class="line">                                   String lowSurrogate = text.substring(currIndex, currIndex + <span class="number">4</span>);</div><div class="line">                                   <span class="keyword">if</span>(invalidCode(lowSurrogate))&#123;</div><div class="line">                                       errorMessage(<span class="string">"invalid unicode!!!"</span>);</div><div class="line">                                   &#125;</div><div class="line">                                   currIndex += <span class="number">3</span>;</div><div class="line">                                   <span class="keyword">int</span> lowCodePoint = computeCodePoint(lowSurrogate);</div><div class="line">                                   <span class="keyword">if</span>(Character.isLowSurrogate((<span class="keyword">char</span>)lowCodePoint))&#123;</div><div class="line">                                       <span class="keyword">if</span>(Character.isSurrogatePair((<span class="keyword">char</span>)highCodePoint, (<span class="keyword">char</span>)lowCodePoint))&#123;</div><div class="line">                                           codePoint = Character.toCodePoint((<span class="keyword">char</span>)highCodePoint, (<span class="keyword">char</span>)lowCodePoint);</div><div class="line">                                           buf.append(Character.toChars(codePoint));</div><div class="line">                                       &#125;<span class="keyword">else</span>&#123;</div><div class="line">                                           errorMessage(<span class="string">"invalid unicode surrogatePair"</span>);</div><div class="line">                                       &#125;</div><div class="line">                                   &#125;<span class="keyword">else</span>&#123;</div><div class="line">                                       errorMessage(<span class="string">"invalid unicode surrogatePair"</span>);</div><div class="line">                                   &#125;</div><div class="line">                               &#125;<span class="keyword">else</span>&#123;</div><div class="line">                                   errorMessage(<span class="string">"expect unicode"</span>);</div><div class="line">                               &#125;</div><div class="line">                           &#125;</div><div class="line">                           <span class="keyword">else</span> <span class="keyword">if</span>(Character.isBmpCodePoint(codePoint))&#123;</div><div class="line">                               currIndex += <span class="number">3</span>;</div><div class="line">                               buf.append(Character.toChars(codePoint));</div><div class="line">                           &#125;<span class="keyword">else</span>&#123;</div><div class="line">                               errorMessage(<span class="string">"invalid highSurrogate"</span>);</div><div class="line">                           &#125;</div><div class="line">                           <span class="keyword">break</span>;</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">default</span>:</div><div class="line">                   <span class="keyword">if</span>(isPrintable(c))&#123;</div><div class="line">                       buf.append((<span class="keyword">char</span>)c);</div><div class="line">                   &#125;<span class="keyword">else</span>&#123;</div><div class="line">                       errorToken();</div><div class="line">                   &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span>(eof())&#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"string quote not correct end!"</span>);</div><div class="line">       &#125;</div><div class="line">       buf.append(<span class="string">"\""</span>);</div><div class="line">       <span class="keyword">this</span>.type = <span class="string">"string"</span>;</div><div class="line">       ++currIndex;</div><div class="line">       <span class="keyword">return</span> buf.toString();</div></pre></td></tr></table></figure></p>
<p>最后就剩下number的处理了。分为整数部分和小数点后面部分。需要注意的0开头的整数，0后面是不能有其他数的。主要就是按照规范来处理就是了。如果都不符合上面提过的token，则为错误token。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">'-'</span>:</div><div class="line">    sign = <span class="string">"-"</span>;</div><div class="line">    ++currIndex;</div><div class="line"><span class="keyword">case</span> <span class="string">'0'</span>:</div><div class="line"><span class="keyword">case</span> <span class="string">'1'</span>:</div><div class="line"><span class="keyword">case</span> <span class="string">'2'</span>:</div><div class="line"><span class="keyword">case</span> <span class="string">'3'</span>:</div><div class="line"><span class="keyword">case</span> <span class="string">'4'</span>:</div><div class="line"><span class="keyword">case</span> <span class="string">'5'</span>:</div><div class="line"><span class="keyword">case</span> <span class="string">'6'</span>:</div><div class="line"><span class="keyword">case</span> <span class="string">'7'</span>:</div><div class="line"><span class="keyword">case</span> <span class="string">'8'</span>:</div><div class="line"><span class="keyword">case</span> <span class="string">'9'</span>:</div><div class="line">&#123;</div><div class="line">    oldIndex = currIndex;</div><div class="line">    ch = charArray[currIndex];</div><div class="line">    <span class="comment">/*</span></div><div class="line">        handle integer part</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (isDigit(ch)) &#123;</div><div class="line">        <span class="keyword">this</span>.type = <span class="string">"number"</span>;</div><div class="line">        <span class="keyword">this</span>.numberType = <span class="string">"int"</span>;</div><div class="line">        currIndex++;</div><div class="line">        <span class="keyword">if</span> (ch != <span class="string">'0'</span>) &#123;</div><div class="line">            <span class="keyword">while</span> (!eof() &amp;&amp; isDigit(charArray[currIndex])) &#123;</div><div class="line">                currIndex++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">/*</span></div><div class="line">            handle double part</div><div class="line">         */</div><div class="line">        <span class="keyword">if</span> (!eof() &amp;&amp; charArray[currIndex] == <span class="string">'.'</span>) &#123;</div><div class="line">            <span class="keyword">this</span>.numberType = <span class="string">"double"</span>;</div><div class="line">            ++currIndex;</div><div class="line">            <span class="keyword">while</span> (!eof() &amp;&amp; isDigit(charArray[currIndex])) &#123;</div><div class="line">                currIndex++;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!eof() &amp;&amp; (charArray[currIndex] == <span class="string">'e'</span> || charArray[currIndex] == <span class="string">'E'</span>)) &#123;</div><div class="line">                ++currIndex;</div><div class="line">                <span class="keyword">if</span> (!eof() &amp;&amp; (charArray[currIndex] == <span class="string">'+'</span> || charArray[currIndex] == <span class="string">'-'</span>)) &#123;</div><div class="line">                    ++currIndex;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">while</span> (!eof() &amp;&amp; isDigit(charArray[currIndex])) &#123;</div><div class="line">                    currIndex++;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sign + text.substring(oldIndex, currIndex);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/*</span></div><div class="line">        case: there isn't digit but other thing after sign symbol.</div><div class="line">        For example： -aaa</div><div class="line">     */</div><div class="line">    <span class="keyword">else</span>&#123;</div><div class="line">        errorToken();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>还有一个函数是peekToken,它的作用是往前看一个token，而不改变下标的值。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">peekToken</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="keyword">int</span> oldIndex = currIndex;</div><div class="line">	String result = nextToken();</div><div class="line">	currIndex = oldIndex;</div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Parser"><a href="#Parser" class="headerlink" title="Parser"></a>Parser</h2><p>JSON的语法非常的简洁，用递归下降法可以很容易的构建成一个解析器。</p>
<p>在开始解析之前，我们先介绍这个辅助函数expect。如果下一个token不是期望的，则boom报错。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">expect</span><span class="params">(String t)</span></span>&#123;</div><div class="line">    String tmp = token.nextToken();</div><div class="line">    <span class="keyword">if</span>(!t.equals(tmp))&#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"expect '"</span> + t +  <span class="string">"' !"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>JSON字符以’{‘开始，我们就以这个开始解析<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">       start parse json string</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">parse</span><span class="params">()</span></span>&#123;</div><div class="line">       expect(<span class="string">"&#123;"</span>);</div><div class="line">       <span class="keyword">return</span> parse_object();</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>来看看object是怎么解析的？JSON obejct是key：value形式，正好对应Java的map。这里我们将JSON object解析成一个map。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">       the json object correspond to java map</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">parse_object</span><span class="params">()</span></span>&#123;</div><div class="line">       Map&lt;String, Object&gt; result = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</div><div class="line"></div><div class="line">       String t = token.nextToken();</div><div class="line">       <span class="comment">/*</span></div><div class="line">           loop handle key:value</div><div class="line">        */</div><div class="line">       <span class="keyword">while</span>(token.getType().equals(<span class="string">"string"</span>))&#123;</div><div class="line">           expect(<span class="string">":"</span>);</div><div class="line">           Object o = parse_value();</div><div class="line">           result.put(removeQuote(t), o);</div><div class="line">           t = token.nextToken();</div><div class="line">           <span class="keyword">if</span>(!t.equals(<span class="string">","</span>) &amp;&amp; !t.equals(<span class="string">"&#125;"</span>))&#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"object format not correct!"</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span>(t.equals(<span class="string">"&#125;"</span>)) <span class="keyword">break</span>;</div><div class="line">           t = token.nextToken();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span>(!t.equals(<span class="string">"&#125;"</span>))&#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"object not correct end!"</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>再来看看解析value的代码。string, true, false, null直接返回相应的内容。遇到object则递归调用parse_object.遇到array则调用parse_array.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">parse_value</span><span class="params">()</span></span>&#123;</div><div class="line">       String t = token.nextToken();</div><div class="line">       String type = token.getType();</div><div class="line">       <span class="keyword">if</span>(<span class="string">"string"</span>.equals(type))&#123;</div><div class="line">           <span class="keyword">return</span> removeQuote(t);</div><div class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"number"</span>.equals(type))&#123;</div><div class="line">           <span class="keyword">if</span>(<span class="string">"int"</span>.equals(token.getNumberType()))&#123;</div><div class="line">               <span class="keyword">return</span> Integer.parseInt(t);</div><div class="line">           &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"double"</span>.equals(token.getNumberType()))&#123;</div><div class="line">               <span class="keyword">return</span> Double.parseDouble(t);</div><div class="line">           &#125;</div><div class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"object"</span>.equals(type))&#123;</div><div class="line">           <span class="keyword">return</span> parse_object();</div><div class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"array"</span>.equals(type))&#123;</div><div class="line">           <span class="keyword">return</span> parse_array();</div><div class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"true"</span>.equals(type))&#123;</div><div class="line">           <span class="keyword">return</span> Boolean.TRUE;</div><div class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"false"</span>.equals(type))&#123;</div><div class="line">           <span class="keyword">return</span> Boolean.FALSE;</div><div class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"null"</span>.equals(type))&#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;<span class="keyword">else</span>&#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"value format error!!!"</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>接下来看看parse_array代码。这里也是递归的调用parse_value。这里使用peekToken的地方，是为了保证之后parse_value不丢失token。如果遇到空array,需要跳过一个token。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">private</span> List&lt;? extends Object&gt; parse_array() &#123;</div><div class="line">    List&lt;Object&gt; result = <span class="keyword">new</span> ArrayList&lt;Object&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">        use peekToken rather than nextToken, in order to correct parse value.</div><div class="line">        The value will lose a token information if here is nextToken.</div><div class="line">     */</div><div class="line">    String t = token.peekToken();</div><div class="line">    <span class="keyword">if</span>(t.equals(<span class="string">"]"</span>))&#123;</div><div class="line">        token.nextToken();</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">while</span>(!t.equals(<span class="string">"]"</span>))&#123;</div><div class="line">            Object o = parse_value();</div><div class="line">            result.add(o);</div><div class="line">            t = token.nextToken();</div><div class="line">            <span class="keyword">if</span>(t.equals(<span class="string">"]"</span>))&#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(!t.equals(<span class="string">","</span>))&#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Syntax error!!!"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            t = token.peekToken();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">if</span>(!t.equals(<span class="string">"]"</span>))&#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"the array not correct end!"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后看一下KSON的API。这里主要的关注点是，我们将JSON字符串转换为map后，我们再将map转为class。直接fied赋值是直接采用set方法。一开始本来想调用用setter来赋值，遇到自动装箱问题就没用了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">fromJsonToMap</span><span class="params">(String json)</span></span>&#123;</div><div class="line">	parser.reset(json);</div><div class="line">	<span class="keyword">return</span> parser.parse();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">fromJson</span><span class="params">(String json, Class&lt;T&gt; clazz)</span></span>&#123;</div><div class="line">	Map&lt;String, Object&gt; map = fromJsonToMap(json);</div><div class="line">	<span class="keyword">return</span> map2class(map, clazz);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toJson</span><span class="params">(Object o)</span></span>&#123;</div><div class="line">	<span class="keyword">return</span> Java2Json.convert(o);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">map2class</span><span class="params">(Map&lt;String, Object&gt; map, Class&lt;T&gt; clazz)</span></span>&#123;</div><div class="line">	T object = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		object = clazz.newInstance();</div><div class="line">		Field fields[] = clazz.getDeclaredFields();</div><div class="line">		String fieldName;</div><div class="line">		<span class="keyword">for</span>(Field field : fields)&#123;</div><div class="line">			field.setAccessible(<span class="keyword">true</span>);</div><div class="line">			fieldName = field.getName();</div><div class="line">			Object value = map.get(fieldName);</div><div class="line">			<span class="comment">/*</span></div><div class="line">			if there use setter , maybe count on java autobox problem.</div><div class="line">			 */</div><div class="line">			field.set(object, value);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</div><div class="line">           e.printStackTrace();</div><div class="line">       &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">           e.printStackTrace();</div><div class="line">	&#125; <span class="keyword">catch</span> (SecurityException e) &#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125; </div><div class="line">	<span class="keyword">return</span> object;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>完整的代码参见：<a href="https://github.com/yuanmie/Kson/blob/master/src/com/yuanmie/json" target="_blank" rel="external">Kson</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2017/06/04/KsonPart2/" data-id="cj5kz8fer0002f4l228jfxqcz" class="article-share-link">分享</a><div class="tags"><a href="/tags/Java-JSON-反射-递归/">Java JSON 反射 递归</a></div><div class="post-nav"><a href="/2017/06/04/KsonPart1/" class="pre">从零开始实现一个简单的JSON库（Java）PART 1</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'yuanmie';
var disqus_identifier = '2017/06/04/KsonPart2/';
var disqus_title = '从零开始实现一个简单的JSON库（Java） PART 2';
var disqus_url = 'http://yoursite.com/2017/06/04/KsonPart2/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/favicon.ico',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//yuanmie.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CSAPP笔记/">CSAPP笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构与算法/">数据结构与算法</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Java-JSON-反射-递归/" style="font-size: 15px;">Java JSON 反射 递归</a> <a href="/tags/数据结构-算法/" style="font-size: 15px;">数据结构 算法</a> <a href="/tags/C-链接-Linux-ELF/" style="font-size: 15px;">C 链接 Linux ELF</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/07/26/信息的表示和处理/">信息的表示和处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/19/red-black-tree-md/">RED-BLACK-TREE(红黑树)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/04/KsonPart1/">从零开始实现一个简单的JSON库（Java）PART 1</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/04/KsonPart2/">从零开始实现一个简单的JSON库（Java） PART 2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//yuanmie.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">Hexo.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>